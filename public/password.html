<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Mon compte</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="login-card" id="loginBox">
  <h2>Connexion</h2>
  <input type="password" id="pwd" class="input" placeholder="Mot de passe">
  <button onclick="login()">Se connecter</button>
</div>

<div class="bank-app" id="account" style="display:none">

  <header class="bank-header">
    <h1>Banque Virtuelle</h1>
    <span id="cardNumber"></span>
  </header>

  <section class="balance-card">
    <p>Solde disponible</p>
    <h2 id="balance">0 €</h2>
  </section>

  <section class="actions">
    <h3>Envoyer de l'argent</h3>
    <input id="to" class="input" placeholder="Carte destinataire">
    <input id="amount" class="input" placeholder="Montant">
    <button onclick="send()">Envoyer</button>
  </section>

  <section class="history">
    <h3>Historique</h3>
    <div id="history"></div>
  </section>

</div>

<script>
const params = new URLSearchParams(window.location.search);
const card = params.get("card");
let current;

function login(){
  fetch("/login", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ card: card, password: pwd.value })
  })
  .then(r=>{
    if(!r.ok) return r.text().then(t=>{throw t});
    return r.json();
  })
  .then(data=>{
    if(data.first){
      const newPwd = prompt("Première connexion : crée ton mot de passe");
      if(!newPwd) return alert("Mot de passe requis");
      fetch("/set-password",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ card: card, password: newPwd })
      }).then(()=>{
        alert("Mot de passe créé, reconnecte-toi");
        pwd.value = "";
      });
    } else {
      current = data;
      loginBox.style.display = "none";
      account.style.display = "block";
      cardNumber.innerText = "Carte : " + current.card;
      update();
    }
  })
  .catch(err=>{
    if(err === "WRONG_PASSWORD") alert("Mot de passe incorrect");
    else alert(err);
  });
}

function update(){
  balance.innerText = current.balance + " €";
  history.innerHTML = current.history.slice().reverse().join("<br>");
}

function send(){
  fetch("/transfer", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      from: current.card,
      to: to.value,
      amount: Number(amount.value)
    })
  })
  .then(r=>{
    if(!r.ok) return r.text().then(t=>{throw t});
    location.reload();
  })
  .catch(alert);
}
</script>

</body>
</html>
